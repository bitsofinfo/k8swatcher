name: Publish to pypi
on: push

jobs:
  build-n-publish:
    name: Build and publish PyPI
    runs-on: ubuntu-18.04
    
    steps:
      - uses: actions/checkout@master
      - name: Set up Python 3.9
        uses: actions/setup-python@v1
        with:
          python-version: 3.9

      - name: Build
        run: |
          pip install --upgrade setuptools setuptools_scm wheel twine
          export GIT_HASH=$(git rev-parse --short "$GITHUB_SHA")
          echo "GIT_HASH: $GIT_HASH"
          sed -i "s/__VERSION_HERE__/$GIT_HASH/g" setup.py
          cat setup.py
          python setup.py sdist bdist_wheel
          
      - name: Upload to test
        env:
          TWINE_PASSWORD: ${{ secrets.TEST_PYPI_API_TOKEN }}
          TWINE_USERNAME: __token__
        run: 
          twine upload --non-interactive -r testpypi dist/* 

      #- name: Publish distribution ðŸ“¦ to Test PyPI
      #  uses: pypa/gh-action-pypi-publish@master
      #  with:
      #    password: ${{ secrets.TEST_PYPI_API_TOKEN }}
      #    repository_url: https://test.pypi.org/legacy/

      #- name: Publish distribution ðŸ“¦ to PyPI
      #  if: startsWith(github.ref, 'refs/tags')
      #  uses: pypa/gh-action-pypi-publish@master
      #  with:
      #    password: ${{ secrets.PYPI_API_TOKEN }}
          